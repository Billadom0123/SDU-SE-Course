# 压力测试

Created by: 我杀了一只猩猩
Created time: August 30, 2023 12:17 AM

## 0.测试目标

数据量：1000乘客发起约车请求、1000司机开始听单

具体服务：派单业务，服务端为这1000个约车请求以及司机分配订单

## 1.环境准备

环境准备分为三个部分：MySQL环境、Redis环境以及Jmeter环境

### 1.MySQL环境准备

派单业务需要同时有两部分数据才能进行：首先要有乘客约车请求，然后要有向服务端表达过听单意愿的司机，因此我们要先在数据库中准备1000个乘客与1000个司机。注意相关的表也要对应的插入数据。

执行附录中SQL脚本:`createBatchUser.sql`。该SQL脚本中创建了4个Procedure，分别用来循环向相关的表中插入：乘客实体，司机实体，车辆实体，司机所属车辆的联系。后二者是由于后端有校验，没有注册过车辆的司机不能接单。

至此MySQL环境准备完毕。

### 2.Redis环境准备

由于派单业务的实现需要借助Redis中的Stream消息队列，而消息队列的创建是在服务端部署上线前就在服务器上完成的。所以需要手动创建。

可以借助Redis可视化客户端:redis-cli。例如，在windows系统下，启动Redis服务，打开客户端，键入以下命令：

```markdown
XGROUP CREATE customer.request g1 0 MKSTREAM
```

这里的消息队列名称，包括服务端的消费者组名称，都是写死的常量。

![Untitled](%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%20f598415a1c954a728f17c4abb3c19ecb/Untitled.png)

之后可以在Redis的图形化客户端RESP中看到这个消息队列

![Untitled](%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%20f598415a1c954a728f17c4abb3c19ecb/Untitled%201.png)

至此Redis的环境准备就绪。

### 3.Jmeter的环境准备

这里假设从零运行这个项目，以此为基础展示如何配置Jmeter数据源。

首先打开Jmeter，导入附录中的脚本：`RideHailing-DispatchOrder-test.jmx`。随后可以看到已经创建了4个线程组，这4个线程组均向服务器指定端口的指定路径发送Http请求，分别是:乘客登陆，司机登陆，乘客发起约车请求，司机发起开始听单。

由于后两个线程组发送的Http请求附带有用户个人的信息，也就是需要鉴权的接口，因此要在请求头中携带token，所以Jmeter环境的准备第一步就是获取Token。但获取方式的Token的方式仅有一种：即请求对应的登陆业务接口，然后才能拿到服务端生成的token。因此在此之前我们要配置首个数据源：用户登陆的数据源。

用户登陆时需要以下参数:

```markdown
{
	"phone":phone,//用户手机号
	"password":password,//用户密码
	"code":code,//用户验证码
	"role_id":role_id//用户类型,1为司机,2为乘客
}
```

由于服务端的逻辑是，登陆时只要提供密码或验证码中的至少一个即可，因此我们配置的数据源中仅选择提供密码，置空验证码。

因此最终的请求中，需要动态的获取三个来自数据源的数据：手机号，密码，用户类型。

对对应线程组添加配置元件：`CSV数据文件设置`。这个数据文件不一定要是.csv格式的，这里我选择了.txt的文本，也是可以的。

![Untitled](%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%20f598415a1c954a728f17c4abb3c19ecb/Untitled%202.png)

随后在变量名称中配置变量名，以逗号分隔，注意不要使用中文，没有对应编码，识别不出来的。

最后在文件路径处选择对应数据源文件。

![Untitled](%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%20f598415a1c954a728f17c4abb3c19ecb/Untitled%203.png)

这个路径不一定适配所有电脑，最好在你本机创建一个专门存放jmeter数据源的文件夹，把需要的文件放进去。

那么这个文件从何来？我使用了MySQLWorkBench中的Export导出功能，将选择的数据导出为.txt文件。

例如，我们之前执行的SQL脚本：`createBatchUser.sql` 最终查询了用户的手机号，我们可以直接在这个查询结果的界面将数据导出。格式可以自己选择。

![Untitled](%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%20f598415a1c954a728f17c4abb3c19ecb/Untitled%204.png)

然后我们将导出文件的所有行适配成jmeter软件要求的格式:不同变量用逗号分隔，一组变量结束换行开始下一行变量，这里以`customer_login.txt` 为例：

![Untitled](%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%20f598415a1c954a728f17c4abb3c19ecb/Untitled%205.png)

由于我为所有用户注册的密码的对应明文都为`“1234567”` ，因此密码可以写死，如果是乘客，那么用户类型字段role_id应该为1。

如此配置两份登陆信息数据源（司机与乘客），然后准备使用jmeter批量请求登陆。

![Untitled](%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%20f598415a1c954a728f17c4abb3c19ecb/Untitled%206.png)

分别启动`Customer-Login`和`Driver-Login` 线程组，这将分别向服务器发送1000条登陆请求。随后token将存入Redis。服务端配置了将日志输出到指定文件的功能，因此我选择将token以日志的方式输出到某个文件中。

![Untitled](%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%20f598415a1c954a728f17c4abb3c19ecb/Untitled%207.png)

注意我输出的路径可能不适配你的计算机，因此最好将服务端输出路径的常量配置修改为你的对应路径。

![Untitled](%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%20f598415a1c954a728f17c4abb3c19ecb/Untitled%208.png)

（修改上图配置）

这样将获取登陆用户的token，作为请求头中`authorization`字段的数据源。

随后是发起约车请求和开始听单的请求。这里需要动态配置的字段为用户id，地理位置坐标（约车开始位置，目标位置，司机当前位置等），以及请求头中的token。

用户id方面，运行附录脚本：`genDriverIdAndCustomerId.sql` ，然后通过上文描述的MySQLWorkBench的Export功能导出对应数据源文件。

地理位置坐标方便，可以新建txt文件设置基准位置，然后在后方拼接jmeter随机字符串函数RandomString返回的随机字符串来实现随机均匀地理坐标。

例如我身处济南，就将济南的大致地理坐标：36，117设置为基准，在此基础上拼接随机字符串。

![Untitled](%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%20f598415a1c954a728f17c4abb3c19ecb/Untitled%209.png)

![Untitled](%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%20f598415a1c954a728f17c4abb3c19ecb/Untitled%2010.png)

至此Jmeter的环境准备就绪。

## 2.压力测试流程以及观测压测结果

由于在环境准备中我们已经运行了两类用户登陆的线程组，因此这里不再需要了。

![Untitled](%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%20f598415a1c954a728f17c4abb3c19ecb/Untitled%2011.png)

运行司机开始听单线程组，将所有司机列入服务端维护的空闲司机的数据结构中。

但只有空闲司机还不够，再运行乘客发起约车请求的线程组，请求约车。

然后观察`C:\\Users\\Administrator\\RideHailingDispatchOrder.txt` 文件，可以看到1000条派发订单的日志。

![Untitled](%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%20f598415a1c954a728f17c4abb3c19ecb/Untitled%2012.png)

也可以观察Jmeter的汇总报告进行性能评估。

至此完成整个派发订单业务的压测。